import pymysql
conn = pymysql.connect(host='40.118.88.187',user='raul',password='P@ssw0rd',db='CHOOSEYOURSTORY')

def main():
    print("*"*105)
    print("")
    print("  /$$$$$$  /$$   /$$  /$$$$$$   /$$$$$$   /$$$$$$  /$$$$$$$$")
    print(" /$$__  $$| $$  | $$ /$$__  $$ /$$__  $$ /$$__  $$| $$_____/")
    print("| $$  \__/| $$  | $$| $$  \ $$| $$  \ $$| $$  \__/| $$")
    print("| $$      | $$$$$$$$| $$  | $$| $$  | $$|  $$$$$$ | $$$$$")
    print("| $$      | $$__  $$| $$  | $$| $$  | $$ \____  $$| $$__/")
    print("| $$    $$| $$  | $$| $$  | $$| $$  | $$ /$$  \ $$| $$")
    print("|  $$$$$$/| $$  | $$|  $$$$$$/|  $$$$$$/|  $$$$$$/| $$$$$$$$")
    print(" \______/ |__/  |__/ \______/  \______/  \______/ |________/")

    print(" /$$     /$$ /$$$$$$  /$$   /$$ /$$$$$$$")
    print("|  $$   /$$//$$__  $$| $$  | $$| $$__  $$")
    print(" \  $$ /$$/| $$  \ $$| $$  | $$| $$  \ $$")
    print("  \  $$$$/ | $$  | $$| $$  | $$| $$$$$$$/")
    print("   \  $$/  | $$  | $$| $$  | $$| $$__  $$")
    print("    | $$   | $$  | $$| $$  | $$| $$  \ $$")
    print("    | $$   |  $$$$$$/|  $$$$$$/| $$  | $$")
    print("    |__/    \______/  \______/ |__/  |__/")

    print("  /$$$$$$  /$$$$$$$$ /$$$$$$  /$$$$$$$  /$$     /$$")
    print(" /$$__  $$|__  $$__//$$__  $$| $$__  $$|  $$   /$$/ ")
    print("| $$  \__/   | $$  | $$  \ $$| $$  \ $$ \  $$ /$$/ ")
    print("|  $$$$$$    | $$  | $$  | $$| $$$$$$$/  \  $$$$/")
    print(" \____  $$   | $$  | $$  | $$| $$__  $$   \  $$/")
    print(" /$$  \ $$   | $$  | $$  | $$| $$  \ $$    | $$  ")
    print("|  $$$$$$/   | $$  |  $$$$$$/| $$  | $$    | $$")
    print(" \______/    |__/   \______/ |__/  |__/    |__/")
    print("")
    print("*" * 105)
    print("")

def final():
    print("")
    print("/ $$$$$$$$  / $$$$$$    / $$   / $$")
    print("| $$_____ / | _  $$_ /  | $$$  | $$")
    print("| $$           | $$     | $$$$ | $$")
    print("| $$$$$        | $$     | $$  $$ $$")
    print("| $$__ /       | $$     | $$   $$$$")
    print("| $$           | $$     | $$ \  $$$")
    print("| $$          / $$$$$$  | $$  \  $$")
    print("|__/         | ______ / | __ / \__ /")
    print("")

def reports():
    print("*" * 105)
    print("")
    print(" /$$$$$$$  /$$$$$$$$ /$$$$$$$   /$$$$$$  /$$$$$$$  /$$$$$$$$ /$$$$$$")
    print("| $$__  $$| $$_____/| $$__  $$ /$$__  $$| $$__  $$|__  $$__//$$__  $$")
    print("| $$  \ $$| $$      | $$  \ $$| $$  \ $$| $$  \ $$   | $$  | $$  \__/")
    print("| $$$$$$$/| $$$$$   | $$$$$$$/| $$  | $$| $$$$$$$/   | $$  |  $$$$$$ ")
    print("| $$__  $$| $$__/   | $$____/ | $$  | $$| $$__  $$   | $$   \____  $$")
    print("| $$  \ $$| $$      | $$      | $$  | $$| $$  \ $$   | $$   /$$  \ $$")
    print("| $$  | $$| $$$$$$$$| $$      |  $$$$$$/| $$  | $$   | $$  |  $$$$$$/")
    print("|__/  |__/|________/|__/       \______/ |__/  |__/   |__/   \______/ ")
    print("")
    print("*" * 105)
    print("")

def title_adventure():
    print("*" * 105)
    print("")
    print(" /$$$$$$$  /$$$$$$$$ /$$       /$$$$$$ /$$    /$$ /$$$$$$$$")
    print("| $$__  $$| $$_____/| $$      |_  $$_/| $$   | $$| $$_____/")
    print("| $$  \ $$| $$      | $$        | $$  | $$   | $$| $$")
    print("| $$$$$$$/| $$$$$   | $$        | $$  |  $$ / $$/| $$$$$")
    print("| $$__  $$| $$__/   | $$        | $$   \  $$ $$/ | $$__/")
    print("| $$  \ $$| $$      | $$        | $$    \  $$$/  | $$")
    print("| $$  | $$| $$$$$$$$| $$$$$$$$ /$$$$$$   \  $/   | $$$$$$$$")
    print("|__/  |__/|________/|________/|______/    \_/    |________/")

    print(" /$$     /$$ /$$$$$$  /$$   /$$ /$$$$$$$")
    print("|  $$   /$$//$$__  $$| $$  | $$| $$__  $$")
    print(" \  $$ /$$/| $$  \ $$| $$  | $$| $$  \ $$")
    print("  \  $$$$/ | $$  | $$| $$  | $$| $$$$$$$/")
    print("   \  $$/  | $$  | $$| $$  | $$| $$__  $$")
    print("    | $$   | $$  | $$| $$  | $$| $$  \ $$")
    print("    | $$   |  $$$$$$/|  $$$$$$/| $$  | $$")
    print("    |__/    \______/  \______/ |__/  |__/")

    print("  /$$$$$$  /$$$$$$$  /$$    /$$ /$$$$$$$$ /$$   /$$ /$$$$$$$$ /$$   /$$ /$$$$$$$  /$$$$$$$$")
    print(" /$$__  $$| $$__  $$| $$   | $$| $$_____/| $$$ | $$|__  $$__/| $$  | $$| $$__  $$| $$_____/")
    print("| $$  \ $$| $$  \ $$| $$   | $$| $$      | $$$$| $$   | $$   | $$  | $$| $$  \ $$| $$ ")
    print("| $$$$$$$$| $$  | $$|  $$ / $$/| $$$$$   | $$ $$ $$   | $$   | $$  | $$| $$$$$$$/| $$$$$  ")
    print("| $$__  $$| $$  | $$ \  $$ $$/ | $$__/   | $$  $$$$   | $$   | $$  | $$| $$__  $$| $$__/ ")
    print("| $$  | $$| $$  | $$  \  $$$/  | $$      | $$\  $$$   | $$   | $$  | $$| $$  \ $$| $$   ")
    print("| $$  | $$| $$$$$$$/   \  $/   | $$$$$$$$| $$ \  $$   | $$   |  $$$$$$/| $$  | $$| $$$$$$$$")
    print("|__/  |__/|_______/     \_/    |________/|__/  \__/   |__/    \______/ |__/  |__/|________/")
    print("")
    print("*" * 105)
    print("")


def checkUser(username):
    if len(username) < 5 or len(username) > 10:
        print("Length of username have to be longer than 5 and shorter than 11")
        return False
    elif username.isalnum() is False:
        print("They can only be alphanumeric characters")
        return False
    else:
        return True

def checkPassword(password):
    length = False
    if len(password) < 8 or len(password) > 12:
        length = False
    else:
        length = True
    upper = False
    lower = False
    digit = False
    not_Alfa = False
    spaces = False
    for i in password:
        if i.islower() is True:
            lower = True
        if i.isupper() is True:
            upper = True
        if i.isdigit() is True:
            digit = True
        if i.isalnum() is False:
            not_Alfa = True
        if i.isspace() is True:
            spaces = True
            break
    if length == True and upper == True and lower == True and digit == True and not_Alfa == True and spaces == False:
        return True
    elif length == False:
        print("Length of password is not correct")
        return False
    elif not_Alfa == False:
        print("Password has to contain some especial character")
        return False
    elif spaces == True:
        print("Password cannot contain spaces")
        return False
    elif digit == False:
        print("Password has to contain some digit")
        return False
    elif lower == False or upper == False:
        print("Password have to include some uppercase and some lowercase")
        return False

def userExists(username):
    cur = conn.cursor()
    query = 'SELECT username from USER'
    conn.ping(reconnect=True)
    cur.execute(query)
    rows_username = cur.fetchall()
    usernames = []
    for i in rows_username:
        usernames.append(i[0])
    if username in usernames:
        print("User exists")
    else:
        return False

def getUsers():
    cur = conn.cursor()
    query = 'select * from USER'
    conn.ping(reconnect=True)
    cur.execute(query)
    rows = cur.fetchall()
    dicGetUsers = {}
    for i in rows:
        dicGetUsers[i[1]] = {'contrasenya': i[2], 'id': i[0]}
    return dicGetUsers

def checkUserbdd(username,password):
    for i in getUsers():
        if username == i:
            if password == getUsers()[i]['contrasenya']:
                return True
            else:
                return False

    return 0

def insertUser(username,password):
    cur=conn.cursor()
    query = f"insert into USER values (id_user,'{username}','{password}',creationdate, creationuser, modificationdate, modificationuser)"
    cur.execute(query)
    conn.commit()
    conn.close()

def getOpt(textOpts="",inputOptText="",rangeList=[],exceptions=[]):
    while True:
        print(textOpts)
        opcion = (input(inputOptText))
        if opcion not in rangeList and opcion not in exceptions:
            print("="*10, "Invalid Option", "="*10)
            input("Press enter to continue")
        else:
            return opcion

def get_adventures_with_chars():
    cur = conn.cursor()
    query = 'select * from ADVENTURE'
    conn.ping(reconnect=True)
    cur.execute(query)
    rows_aventuras = cur.fetchall()
    dicadventures = {}
    for i in rows_aventuras:
        query2 = 'select id_personage from STARRING where id_adventure = ' + str(i[0])
        cur.execute(query2)
        rows_protagonitzen = cur.fetchall()
        protagonitzen = []
        for j in rows_protagonitzen:
            for k in j:
                protagonitzen.append(k)
        dicadventures[i[0]] = {'Name': i[1], 'Description': i[2], 'characters': protagonitzen}
    return dicadventures

def getHeader(text):
    result = "*"*105 + "\n"
    result += str(text).center(105,"=") + "\n"
    return result + "*"*105

def getHeaderForTableFromTuples(t_name_columns,t_size_columns,title=""):
    result = str(title).center(105,"=")+"\n\n"
    count = 0
    for i in t_name_columns:
        result += t_name_columns[count]+" "*(t_size_columns[count]-len(t_name_columns[count]))
        count += 1
    result += "\n"
    result += "*"*105
    return result + "\n"

def getFormatedBodyColumns(tupla_texts,tupla_sizes,margin=0):
    #creamos una variable vacia
    resultado = ""
    #creamos una lista vacia
    listaTextos = []
    #creamos un for para recorrernos todos los textos que le pasamos a la funcion y los añadimos a la lista
    for i in range(len(tupla_texts)):
        listaTextos.append(formatText(tupla_texts[i],tupla_sizes[i]-margin,"XXXX"))
    #creamos variable de tamaño
    totalSize = 0
    #creamos un for para recorrernos toda la lista y ver cuantos textos hay
    for i in range(len(listaTextos)):
        totalSize +=len(listaTextos[i])
    #iniciamos el bucle si ningun texto esta vacio
    while totalSize > 0:
        # creamos un for para recorrernos la lista y buscar el elemento "XXXX"
        for i in range(len(listaTextos)):
            final = listaTextos[i].find("XXXX")
            if final != -1:
                resultado += (listaTextos[i][0:final]+" "*margin).ljust(tupla_sizes[i])
                listaTextos[i] = listaTextos[i][listaTextos[i].find("XXXX")+4:]
            else:
                resultado += (listaTextos[i] + " "*margin).ljust(tupla_sizes[i])
                listaTextos[i] = ""
        resultado += "\n"
        totalSize = 0
        # creamos un for para recorrernos toda la lista y ver cuantos textos hay
        for i in range(len(listaTextos)):
            totalSize += len(listaTextos[i])
    # devolvemos resultado
    return resultado

def getFormatedAdventures(adventures):
    result = getHeaderForTableFromTuples(('Id Adventure','Adventure','Description'),(15,40,35),"Adventures") +"\n"
    for i in adventures:
        result += getFormatedBodyColumns((str(i),str(adventures[i]['Name']),str(adventures[i]['Description'])),(15,40,50),0)
    return result

def get_characters():
    cur = conn.cursor()
    query = 'select * from PERSONAGE'
    cur.execute(query)
    rows = cur.fetchall()
    diccharacters = {}
    for i in rows:
        diccharacters[i[0]] = f'{i[1]}'
    return diccharacters

def get_id_bystep_adventure():
    cur = conn.cursor()
    query = 'SELECT p.id_step, p.description, o.id_answer, p.final_step FROM STEP p INNER JOIN CHOICE o ON p.id_step = o.id_actual_step'
    conn.ping(reconnect=True)
    cur.execute(query)
    rows = cur.fetchall()
    dicid_by_steps = {}
    for i in rows:
        query2 = 'SELECT o.id_answer FROM STEP p INNER JOIN CHOICE o ON p.id_step = o.id_actual_step where id_step = ' + str(i[0])
        cur.execute(query2)
        rows_ids_respuestas = cur.fetchall()
        dicid_by_steps[i[0]] = {'Description': i[1], 'answers_in_step': rows_ids_respuestas, 'Final_Step': i[3]}
    return dicid_by_steps


def get_answers_bystep_adventure():
    cur = conn.cursor()
    query = 'SELECT r.id_answer, p.id_step, p.description, r.description, o.id_next_step FROM CHOICE o INNER JOIN ANSWER r ON o.id_answer = r.id_answer INNER JOIN STEP p ON o.id_actual_step = p.id_step'
    cur.execute(query)
    rows = cur.fetchall()
    dicidAnswers_ByStep_Adventure = {}
    for i in rows:
        dicidAnswers_ByStep_Adventure[(i[0],i[1])] = {'Description': i[2], 'Resolution_Answer': i[3], 'NextStep_Adventure': i[4]}
    return dicidAnswers_ByStep_Adventure

def get_id_choice(id_step):
    cur = conn.cursor()
    query = 'select * from CHOICE where id_actual_step = ' + str(id_step)
    conn.ping(reconnect=True)
    cur.execute(query)
    rows = cur.fetchall()
    return rows

def get_id_answer(id_choice):
    cur = conn.cursor()
    query = 'select * from ANSWER where id_answer = ' + id_choice
    cur.execute(query)
    rows = cur.fetchall()
    return rows

def formatText(text,lenLine,split):
    result = ""
    while len(text) > lenLine:
        inicio = lenLine - 1
        while text.find(" ", inicio, lenLine) == -1:
            inicio = inicio - 1
        result = result + text[0:inicio] + split
        text = text[inicio:].lstrip()
    result = result + text + split
    return result

def getIdUser(username):
    cur = conn.cursor()
    query = f'select id_user from USER where username = "{username}"'
    cur.execute(query)
    conn.close()
    rows = cur.fetchall()
    for i in rows:
        id_user = i[0]
    return id_user

def setIdGame():
    conn.commit()

def insertCurrentGame(id_user,id_personage,id_adventure):
    cur = conn.cursor()
    query = f"insert into GAME values (id_game,date,hour,'{id_user}','{id_personage}','{id_adventure}',(select CURRENT_TIMESTAMP()), creationuser, modificationdate, modificationuser)"
    conn.ping(reconnect=True)
    cur.execute(query)
    setIdGame()
    conn.close()

def header_replay_adventures():
    result = "="*105 + "\n"
    result += "Id".ljust(15) + "Username".ljust(20) + "Name".ljust(28) + "CharacterName".ljust(20) + "date".ljust(15) + "\n"
    result += "*"*105
    return result

def games():
    cur = conn.cursor()
    query = 'select g.id_game, u.username, a.name, p.name, g.creationdate from GAME g INNER JOIN USER u ON g.id_user=u.id_user INNER JOIN ADVENTURE a ON g.id_adventure=a.id_adventure INNER JOIN PERSONAGE p ON g.id_personage=p.id_personage order by creationdate desc'
    conn.ping(reconnect=True)
    cur.execute(query)
    conn.close()
    rows = cur.fetchall()
    return rows

def player_more_games():
    cur = conn.cursor()
    query = 'select u.username, count(g.id_game) as "Games" from GAME g INNER JOIN USER u ON g.id_user=u.id_user group by u.username order by count(g.id_game) desc limit 1;'
    conn.ping(reconnect=True)
    cur.execute(query)
    conn.close()
    rows = cur.fetchall()
    return rows

def games_played_user(username):
    cur = conn.cursor()
    query = f'select a.id_adventure, a.name, g.creationdate from GAME g INNER JOIN USER u ON g.id_user=u.id_user INNER JOIN ADVENTURE a ON g.id_adventure=a.id_adventure where u.username= "{username}" order by creationdate desc;'
    conn.ping(reconnect=True)
    cur.execute(query)
    conn.close()
    rows = cur.fetchall()
    return rows

def identificador_game():
    cur = conn.cursor()
    query = f'SELECT max(id_game) from GAME;'
    conn.ping(reconnect=True)
    cur.execute(query)
    conn.close()
    rows = cur.fetchall()
    for i in rows:
        result = i[0]
    return result

def insert_decisions(choice,game,step):
    cur = conn.cursor()
    query = f"insert into DECISIONMAKING values ('{choice}','{game}','{step}',creationdate,creationuser,modificationdate,modificationuser)"
    conn.ping(reconnect=True)
    cur.execute(query)
    conn.commit()
    conn.close()

def name_adventure(id_adventure):
    cur = conn.cursor()
    query = f'select a.name from GAME g INNER JOIN ADVENTURE a ON g.id_adventure=a.id_adventure where id_game = ' + id_adventure
    conn.ping(reconnect=True)
    cur.execute(query)
    conn.commit()
    conn.close()
    rows = cur.fetchall()
    for i in rows:
        name = i[0]
    return name

def option_replay(id_adventure):
    cur = conn.cursor()
    query = f'SELECT id_choice, id_step from DECISIONMAKING where id_game = {id_adventure} order by id_step'
    conn.ping(reconnect=True)
    cur.execute(query)
    conn.commit()
    conn.close()
    rows = cur.fetchall()
    return rows

def answer_more_used():
    cur = conn.cursor()
    query = f'select concat(ad.id_adventure," - " ,ad.name) as Adventure, concat(s.id_step," - ",s.description) as Step,concat(d.id_choice,  " - " ,c.description) as Elección, count(a.id_answer) from CHOICE c INNER JOIN STEP s ON c.id_actual_step=s.id_step INNER JOIN ANSWER a ON c.id_answer=a.id_answer INNER JOIN (select * from DECISIONMAKING where id_step not in (2,4,5)) d ON c.id_choice=d.id_choice INNER JOIN GAME g ON d.id_game=g.id_game INNER JOIN ADVENTURE ad ON g.id_adventure=ad.id_adventure group by d.id_choice, ad.id_adventure order by d.id_choice asc;'
    conn.ping(reconnect=True)
    cur.execute(query)
    conn.commit()
    conn.close()
    rows = cur.fetchall()
    return rows

def getHeaderAnswers(t_name_columns,title=""):
    result = str(title).center(120,"=")+"\n"
    result += str(t_name_columns) + "\n"
    result += "*"*120 + "\n"
    return result

def name_character(id_game):
    cur = conn.cursor()
    query = f'select name from PERSONAGE p INNER JOIN GAME g ON p.id_personage=g.id_personage where id_game = ' + id_game
    conn.ping(reconnect=True)
    cur.execute(query)
    conn.commit()
    conn.close()
    rows = cur.fetchall()
    return rows

def getReplayAdventures():
    cur = conn.cursor()
    query = 'SELECT p.id_game, u.id_user, u.username, a.id_adventure, a.name, a.creationdate as date, per.id_personage, per.name FROM GAME p INNER JOIN USER u ON p.id_user = u.id_user INNER JOIN ADVENTURE a ON p.id_adventure = a.id_adventure INNER JOIN PERSONAGE per ON p.id_personage = per.id_personage'
    cur.execute(query)
    rows = cur.fetchall()
    dicReplayAdventures = {}
    for i in rows:
        dicReplayAdventures[i[0]] = {'idUser': i[1], 'Username': i[2], 'idAdventure': i[3], 'Name': i[4], 'date': i[5], 'idCharacter': i[6], 'CharacterName': i[7]}
    return dicReplayAdventures

def getIdGames():
    cur = conn.cursor()
    query = 'select id_game from GAME'
    cur.execute(query)
    rows = cur.fetchall()
    ids = []
    for i in rows:
        for j in i:
            ids.append(j)
    return tuple(ids)

def getUserIds():
    cur = conn.cursor()
    query = 'SELECT username from USER'
    cur.execute(query)
    rows_username = cur.fetchall()
    query2 = 'SELECT id_user from USER'
    cur.execute(query2)
    rows_id = cur.fetchall()
    dic_username = []
    dic_ids = []
    dic_user_id = []
    for i in rows_username:
        for j in i:
            dic_ids.append(j)
    for k in rows_id:
        for h in k:
            dic_username.append(h)
    dic_user_id.append(dic_ids)
    dic_user_id.append(dic_username)
    return dic_user_id

def get_table(query):
    cur = conn.cursor()
    cur.execute(query)
    rows = cur.fetchall()
    columnas = cur.description
    tupla_columnas = []
    for i in columnas:
        tupla_columnas.append(i[0])
    tupla_columnas = tuple(tupla_columnas)
    return tupla_columnas, rows

def get_first_step_adventure():
    cur = conn.cursor()
    query = 'SELECT id_adventure, (SELECT id_step from STEP where id_step=1) as id_step FROM ADVENTURE'
    cur.execute(query)
    rows = cur.fetchall()
    return rows

def getFormatedAnswers(idAnswer,text):
    result = ""
    result += f"{idAnswer}) {text}"
    return result